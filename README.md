# 📈 주식 종목 탐색 서비스

> **자연어로 묻고, AI가 찾아드립니다.**  
> 국내 상장 종목 전체를 대상으로 테마·업종·종목명을 자유롭게 질문하면,  
> Elasticsearch 하이브리드 검색 + GPT가 관련 종목을 찾아 요약 답변과 주가 차트까지 제공합니다.

---

## 목차

1. [서비스 개요](#1-서비스-개요)
2. [주요 기능](#2-주요-기능)
3. [기술 스택](#3-기술-스택)
4. [프로젝트 구조](#4-프로젝트-구조)
5. [아키텍처](#5-아키텍처)
6. [사전 준비](#6-사전-준비)
7. [설치 및 실행](#7-설치-및-실행)
8. [데이터 적재](#8-데이터-적재)
9. [사용 방법](#9-사용-방법)
10. [검색 신뢰도 기준](#10-검색-신뢰도-기준)
11. [주요 함수 설명](#11-주요-함수-설명)
12. [자주 묻는 질문](#12-자주-묻는-질문-faq)

---

## 1. 서비스 개요

이 프로젝트는 **RAG(Retrieval-Augmented Generation)** 기술을 활용한 주식 탐색 챗봇입니다.

사용자가 자연어로 질문하면 세 단계로 답변을 생성합니다.

```
① 질문 접수  →  ② 관련 종목 검색 (Elasticsearch)  →  ③ GPT 요약 답변 생성
```

단순 키워드 검색이 아니라 **문맥(의미)**과 **키워드**를 동시에 활용하기 때문에, "여름에 수혜를 받는 종목", "전쟁 관련주" 같은 테마 질문도 잘 처리합니다.

---

## 2. 주요 기능

### 🔍 하이브리드 검색 (Hybrid Search)
- **시맨틱 검색**: OpenAI 임베딩(`text-embedding-3-small`)으로 벡터 유사도 검색
- **렉시컬 검색**: Elasticsearch `multi_match`로 회사명·업종·주요제품 키워드 검색
- **RRF(Reciprocal Rank Fusion)**: 두 검색 결과를 수학적으로 결합해 최적의 순위 도출
- 회사명 직접 검색 시 정확도를 높이기 위해 `회사명^3`, `업종^2` 가중치 적용

### 🎯 검색 신뢰도 표시
- 검색된 각 종목의 RRF 점수를 **🟢 높음 / 🟡 보통 / 🔴 낮음** 3단계로 시각화
- 답변의 근거가 충분한지 사용자가 직접 판단 가능

### 📊 주가 시계열 차트
- "삼성전자 주가 보여줘" → 상장일부터 현재까지 자동 조회
- "2023년 주가 보여줘" → 해당 기간만 표시
- 종목이 2개 이상이면 **상대 수익률 비교 모드** 토글 제공 (기준일=100 정규화)

### 💬 멀티턴 대화
- 이전 대화 맥락을 최근 6턴까지 LLM에 전달
- "그 중에서 시총 큰 것만", "방금 말한 종목 주가 보여줘" 같은 후속 질문 처리 가능

### 📋 종목 상세 정보
- 검색된 종목의 종목코드·업종·주요제품 등 KRX 데이터 기반 상세 테이블 제공

---

## 3. 기술 스택

| 분류 | 기술 |
|------|------|
| **프론트엔드** | Streamlit |
| **검색 엔진** | Elasticsearch 8.x |
| **임베딩 모델** | OpenAI `text-embedding-3-small` (1536차원) |
| **LLM** | OpenAI `gpt-4o-mini` |
| **주가 데이터** | FinanceDataReader (KRX 기반) |
| **차트** | Plotly |
| **데이터 소스** | KRX KIND 상장법인 목록 |
| **언어** | Python 3.10+ |

---

## 4. 프로젝트 구조

```
📦 rag-stock-assistant/
├── 📄 app.py              # Streamlit 메인 앱 (UI 및 흐름 제어)
├── 📄 rag_module.py       # RAG 핵심 로직 (검색·임베딩·LLM 호출)
├── 📄 data_loader.py      # KRX 데이터 수집 및 ES 인덱스 적재
├── 📄 .env                # 환경변수 (API 키 등) ← 직접 생성 필요
├── 📄 requirements.txt    # 패키지 목록
└── 📄 README.md           
```

---

## 5. 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        사용자 질문                            
│           "2차전지 소재 관련주 주가 비교해줘"                     
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  1단계: 질문 분석 (LLM)                                      
│  • 주가 조회 여부 판단                                         
│  • 날짜 범위 추출 (없으면 상장일 ~ 오늘)                           
│  • 이전 대화 맥락 반영                                        
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2단계: 하이브리드 검색 (Elasticsearch)                       
│                                                         
│  질문 텍스트                                                 
│      ├─→ [시맨틱 검색] OpenAI 임베딩 → KNN 벡터 검색          
│      └─→ [렉시컬 검색] multi_match (회사명^3, 업종^2, 주요제품)
│                                                              
│  두 결과를 RRF로 결합 → 신뢰도 점수 부여 → 상위 5개 종목 선택  
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3단계: 답변 생성 (GPT-4o-mini)                               
│  • 검색된 종목 상세 정보를 컨텍스트로 전달                       
│  • 이전 대화 이력(최근 6턴) 포함                                
│  • 주가 질문이면 간략 소개 + 차트 안내                          
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4단계: UI 렌더링 (Streamlit)                                 
│  • 텍스트 답변                                                
│  • 검색 신뢰도 카드 (🟢🟡🔴)                                  
│  • 종목 상세 데이터 테이블                                      
│  • 주가 시계열 차트 (절대값 / 상대 수익률 비교 모드)              
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 사전 준비

### 필수 환경

- Python **3.10 이상**
- **Elasticsearch 8.x** 로컬 실행 (`http://localhost:9200`)
- **OpenAI API 키**

### Elasticsearch 설치 (처음 설치하는 경우)

Docker를 사용하면 가장 간편합니다.

```bash
docker run -d \
  --name elasticsearch \
  -p 9200:9200 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  docker.elastic.co/elasticsearch/elasticsearch:8.13.0
```

> 설치 후 `http://localhost:9200` 에 접속해 `{"tagline": "You Know, for Search"}` 응답이 오면 정상입니다.

---

## 7. 설치 및 실행

### Step 1. 저장소 클론

```bash
git clone https://github.com/your-repo/rag-stock-assistant.git
cd rag-stock-assistant
```

### Step 2. 가상환경 생성 및 패키지 설치

```bash
python -m venv venv
source venv/bin/activate        # Windows: venv\Scripts\activate

pip install -r requirements.txt
```

### Step 3. 환경변수 설정

프로젝트 루트에 `.env` 파일을 생성하고 OpenAI API 키를 입력합니다.

```bash
# .env
AI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### Step 4. 앱 실행

```bash
streamlit run app.py
```

브라우저에서 `http://localhost:8501` 로 접속하면 됩니다.

---

## 8. 데이터 적재

앱을 처음 실행하기 전에 **반드시 1회** KRX 데이터를 Elasticsearch에 적재해야 합니다.

```bash
python elastic_bulk.py
```

이 스크립트는 다음 작업을 순서대로 수행합니다.

| 단계 | 내용 |
|------|------|
| ① 데이터 수집 | KRX KIND에서 전체 상장법인 목록 다운로드 |
| ② 텍스트 생성 | 각 종목의 컬럼을 하나의 문장으로 병합 |
| ③ 임베딩 생성 | OpenAI API로 1536차원 벡터 변환 (100개씩 배치 처리) |
| ④ 인덱스 생성 | ngram 분석기 + dense_vector 매핑으로 ES 인덱스 생성 |
| ⑤ 데이터 적재 | Bulk API로 전체 종목 한번에 업로드 |

> 💡 상장사 수가 약 2,500개이므로 임베딩 생성에 **1~2분** 정도 소요됩니다.  
> OpenAI API 비용은 `text-embedding-3-small` 기준 약 **$0.02 미만**입니다.

### Elasticsearch 인덱스 구조

```json
{
  "회사명":   { "type": "text", "analyzer": "ngram_analyzer", "fields": {"keyword": {"type": "keyword"}} },
  "업종":     { "type": "text", "analyzer": "ngram_analyzer" },
  "주요제품": { "type": "text", "analyzer": "ngram_analyzer" },
  "종목코드": { "type": "keyword" },
  "embedding":{ "type": "dense_vector", "dims": 1536, "index": true, "similarity": "cosine" }
}
```

> ngram 분석기(`min_gram=2`, `max_gram=5`)를 사용해 "삼성", "삼성전", "삼성전자" 등 부분 문자열도 검색됩니다.

---

## 9. 사용 방법

### 기본 질문

| 질문 유형 | 예시 |
|-----------|------|
| 테마 검색 | `여름 관련주 추천해줘`, `전쟁 관련 수혜주 알려줘` |
| 업종 검색 | `2차전지 소재 기업 찾아줘`, `반도체 장비 관련주는?` |
| 종목 직접 | `삼성전자 어떤 회사야?`, `카카오 관련 정보 보여줘` |
| 주가 조회 | `삼성전자 주가 보여줘` (상장일 ~ 오늘) |
| 기간 지정 | `SK하이닉스 2022년 주가`, `LG에너지솔루션 2023년 1월부터 6월까지` |
| 종목 비교 | `삼성전자와 SK하이닉스 최근 1년 주가 비교` |

### 후속 질문 (멀티턴)

```
👤 2차전지 관련주 알려줘
🤖 [에코프로, 포스코퓨처엠, LG에너지솔루션 등 소개]

👤 그 중에서 주가 보여줘        ← 맥락을 이어서 처리
🤖 [방금 검색된 종목들의 주가 차트 표시]

👤 2022년부터 비교해줘          ← 기간도 이어서 처리
🤖 [2022년부터 현재까지 상대 수익률 비교 차트]
```

### 주가 차트 사용법

1. 주가 관련 질문을 하면 답변 아래 자동으로 차트가 표시됩니다.
2. 종목이 **2개 이상**이면 차트 위에 **"📊 상대 수익률 비교 모드"** 토글이 나타납니다.
3. 토글을 켜면 기준일 종가를 100으로 정규화해 수익률 기준으로 비교할 수 있습니다.

---

## 10. 검색 신뢰도 기준

검색 신뢰도는 **RRF(Reciprocal Rank Fusion) 점수** 기반입니다.

### RRF 점수 계산 방식

```
RRF 점수 = 1/(60 + 시맨틱 순위)  +  1/(60 + 렉시컬 순위)
```

- 시맨틱 검색과 렉시컬 검색 **양쪽에서 모두 상위**로 등장하면 점수가 합산됩니다.
- 이론적 최대값: `1/61 + 1/61 ≈ 0.0328` (양쪽 모두 1위인 경우)

### 등급 기준

| 등급 | RRF 점수 | 의미 |
|------|----------|------|
| 🟢 높음 | ≥ 0.030 | 시맨틱 + 렉시컬 **양쪽 모두** 상위권 등장. 질문과 매우 관련 높음 |
| 🟡 보통 | ≥ 0.016 | **한쪽** 검색에서 상위권 등장. 어느 정도 관련 있음 |
| 🔴 낮음 | < 0.016 | 한쪽 검색의 **하위권**에만 등장. 참고 수준으로 활용 권장 |

> 💡 **낮음** 등급이 많이 나온다면 질문을 더 구체적으로 바꿔보세요.  
> 예) `주식 추천` → `태양광 관련 소재 제조 기업 추천`

---

## 11. 주요 함수 설명

### `rag_module.py`

| 함수 | 설명 |
|------|------|
| `get_es_client()` | Elasticsearch 클라이언트 반환 |
| `get_openai_client()` | OpenAI 클라이언트 반환 (`.env`의 `AI_API_KEY` 사용) |
| `get_embedding(client, text)` | 텍스트 → 1536차원 벡터 변환 |
| `search_hybrid(es, client, query, k=5)` | 하이브리드 검색 실행 후 RRF 점수 포함 결과 반환 |
| `get_confidence_label(score)` | RRF 점수 → `("높음"/"보통"/"낮음", 이모지)` 변환 |
| `search_stock_details(es, names)` | 회사명 목록으로 ES에서 상세 정보 조회 |
| `detect_price_query(client, query, history)` | 주가 조회 여부 및 날짜 범위 추출 (LLM 사용) |
| `answer_question(es, client, query, history)` | RAG 전체 파이프라인 실행, `(답변, scored_docs, price_info)` 반환 |

### `app.py`

| 함수 | 설명 |
|------|------|
| `init_clients()` | ES·OpenAI 클라이언트 초기화 (`@st.cache_resource`) |
| `fetch_price_data(details, start, end)` | 종목 리스트의 주가 데이터를 FinanceDataReader로 조회 |
| `render_price_chart(data, start, end, compare)` | Plotly 시계열 차트 렌더링 (절대값 / 상대 수익률) |
| `render_chart_section(chart_params)` | 차트 + 비교 모드 토글 통합 렌더링 |
| `render_confidence_badges(scored_docs)` | 종목별 신뢰도 카드 UI 렌더링 |

---

## 12. 자주 묻는 질문 (FAQ)

**Q. Elasticsearch에 연결이 안 돼요.**  
A. Docker 컨테이너가 실행 중인지 확인하세요. `docker ps` 명령으로 확인하거나, `curl http://localhost:9200` 으로 응답이 오는지 확인해 보세요.

**Q. `AI_API_KEY 환경변수가 설정되지 않았습니다` 오류가 나요.**  
A. 프로젝트 루트에 `.env` 파일이 있는지, `AI_API_KEY=sk-...` 형식으로 정확히 입력됐는지 확인하세요.

**Q. 데이터 적재(`data_loader.py`) 후에도 검색 결과가 없어요.**  
A. Elasticsearch 인덱스가 정상적으로 생성됐는지 확인하세요.  
```bash
curl http://localhost:9200/stock_info/_count
```
`count` 값이 0이면 적재가 실패한 것입니다. 오류 메시지를 확인 후 재실행하세요.

**Q. 주가 차트가 안 나와요.**  
A. FinanceDataReader가 KRX에서 데이터를 가져오지 못하는 경우입니다. 종목코드가 6자리 숫자인지 확인하고, 인터넷 연결 상태를 점검하세요.

**Q. 신뢰도가 계속 🔴 낮음으로만 나와요.**  
A. 질문이 너무 일반적이면 두 검색 모두에서 낮은 순위를 기록할 수 있습니다. 더 구체적인 키워드(업종명, 주요제품명)를 포함해 질문해 보세요.

**Q. 멀티턴이 잘 안 되는 것 같아요.**  
A. 대화 이력은 최근 **6턴**까지만 유지됩니다. 대화가 길어지면 오래된 맥락은 잊혀집니다. 필요하다면 사이드바의 **대화 초기화** 버튼으로 새로 시작하세요.

---

## 13. 트러블슈팅
1. 신뢰도가 🔴 '낮음'만 나옴
- 원인: 시맨틱·렉시컬 검색 중 한쪽에서만 하위권에 등장
- 해결: rag_module.py의 임계값을 현재 데이터에 맞게 조정합니다
    - 임계값을 낮춰서 보통 등급 범위를 넓혔습니다.
    - CONFIDENCE_THRESHOLDS = {"높음": 0.025, "보통": 0.012}

2. Elasticsearch 렉시컬 검색이 완전 일치가 아닌 부분 매칭으로만 동작함
- 증상: "카카오"를 검색했을 때 "카카오" 보다 "카카오페이", "카카오뱅크" 같은 파생 종목이 더 높은 순위로 반환
- 원인: multi_match는 형태소/ngram 단위로 쪼개진 토큰을 매칭하므로 부분 문자열 포함 여부로 점수를 매깁니다. "카카오페이"는 "카카오"라는 토큰을 포함하고 있어 검색 점수가 높게 나올 수 있습니다. 반면 완전 일치(Exact Match) 에 대한 별도 가중치가 없기 때문에 정확히 이름이 일치하는 종목이 하위로 밀립니다.
- 해결: rag_module.py의 search_hybrid() 함수에서 렉시컬 검색 쿼리를 bool 쿼리로 교체하고, 회사명.keyword 완전 일치 조건에 높은 boost를 부여합니다.
